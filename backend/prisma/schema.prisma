// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Profile {
  id        String   @id @default(cuid())
  email     String   @unique
  username  String   @unique
  password  String
  avatar_url String?
  bio       String?
  coins     Int      @default(100)
  rating    Float    @default(5.0)
  role      String   @default("user")  // "user" or "admin"
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Location fields for distance-based matching
  latitude  Float?
  longitude Float?
  city      String?
  town      String?
  state     String?
  country   String?
  pincode   String?

  listings    Listing[]
  trades_initiated Trade[] @relation("trades_initiator")
  trades_received  Trade[] @relation("trades_responder")
  coin_transactions CoinTransaction[]
  sessions_as_provider Session[] @relation("provider")
  sessions_as_participant Session[] @relation("participant")
  messages_sent Message[] @relation("sender")
  messages_received Message[] @relation("receiver")
  conversations Conversation[]

  @@index([email])
  @@index([username])
  @@index([role])
}

model Listing {
  id           String   @id @default(cuid())
  owner_id     String
  owner        Profile  @relation(fields: [owner_id], references: [id], onDelete: Cascade)
  
  title        String
  description  String   @db.Text
  category     String
  image_url    String?
  is_service   Boolean  @default(false)
  status       ListingStatus @default(ACTIVE)
  
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  trades       Trade[]

  @@index([owner_id])
  @@index([category])
  @@index([status])
}

model Trade {
  id                 String   @id @default(cuid())
  initiator_id       String
  initiator          Profile  @relation("trades_initiator", fields: [initiator_id], references: [id], onDelete: Cascade)
  
  responder_id       String
  responder          Profile  @relation("trades_responder", fields: [responder_id], references: [id], onDelete: Cascade)
  
  listing_id         String
  listing            Listing  @relation(fields: [listing_id], references: [id], onDelete: Cascade)
  
  proposed_listing_id String?
  coin_amount        Int      @default(0)
  message            String?  @db.Text
  
  status             TradeStatus @default(PENDING)
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  @@index([initiator_id])
  @@index([responder_id])
  @@index([listing_id])
  @@index([status])
}

model CoinTransaction {
  id        String   @id @default(cuid())
  user_id   String
  user      Profile  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  amount    Int
  reason    String
  created_at DateTime @default(now())

  @@index([user_id])
}

enum ListingStatus {
  ACTIVE
  TRADED
  ARCHIVED
}

enum TradeStatus {
  PENDING
  ACCEPTED
  REJECTED
  COMPLETED
}

enum SessionStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

model Session {
  id           String   @id @default(cuid())
  
  provider_id  String
  provider     Profile  @relation("provider", fields: [provider_id], references: [id], onDelete: Cascade)
  
  participant_id String
  participant    Profile @relation("participant", fields: [participant_id], references: [id], onDelete: Cascade)
  
  skill_title  String
  description  String?  @db.Text
  
  scheduled_at DateTime
  duration_minutes Int   @default(60)  // Duration in minutes
  
  status       SessionStatus @default(SCHEDULED)
  location     String?
  meeting_link String?  // For online sessions
  
  notes        String?  @db.Text
  feedback     String?  @db.Text
  rating       Float?
  
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  @@index([provider_id])
  @@index([participant_id])
  @@index([status])
  @@index([scheduled_at])
}

model Conversation {
  id           String   @id @default(cuid())
  
  user_id      String
  user         Profile  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  other_user_id String
  
  last_message String?
  last_message_at DateTime?
  
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  @@unique([user_id, other_user_id])
  @@index([user_id])
  @@index([updated_at])
}

model Message {
  id           String   @id @default(cuid())
  
  sender_id    String
  sender       Profile  @relation("sender", fields: [sender_id], references: [id], onDelete: Cascade)
  
  receiver_id  String
  receiver     Profile  @relation("receiver", fields: [receiver_id], references: [id], onDelete: Cascade)
  
  content      String   @db.Text
  
  is_read      Boolean  @default(false)
  read_at      DateTime?
  
  created_at   DateTime @default(now())

  @@index([sender_id])
  @@index([receiver_id])
  @@index([is_read])
  @@index([created_at])
}
